<script>
  var video = document.createElement("video");
  var QRAreaElement = document.getElementById("QR-area");
  var canvasElement = document.getElementById("canvas");
  var canvas = canvasElement.getContext("2d");
  var loadingMessage = document.getElementById("loadingMessage");
  var batsudiv=document.getElementsByClassName('batsu')[0];
  this.a1=document.getElementsByClassName('1a');
  this.s1=document.getElementsByClassName('1s');
  this.a2=document.getElementsByClassName('2a');
  this.s2=document.getElementsByClassName('2s');

  function generateReg(liff_id, ver="2023-f") {
    // var reg=/https:\/\/liff\.line\.me\/1657251421-qOdzWROa\/\?ver=2023-f\&place_id=(\d+)/;
    self.reg=new RegExp(`^https://liff\.line\.me/${liff_id}/\\?ver=${ver}\\&(place_id|card_token)=([\\w-]+)`);
  }

  function drawLine(begin, end, color) {
    canvas.beginPath();
    canvas.moveTo(begin.x, begin.y);
    canvas.lineTo(end.x, end.y);
    canvas.lineWidth = 4;
    canvas.strokeStyle = color;
    canvas.stroke();
  }

  // Use facingMode: environment to attemt to get the front camera on phones
  const startScan=()=>navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
    video.srcObject = stream;
    video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
    video.play();
    requestAnimationFrame(tick);
  });

  function tick() {
    loadingMessage.innerText = "⌛ Loading video..."
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
    loadingMessage.hidden = true;
    QRAreaElement.hidden = false;
    ccw=document.getElementsByClassName('container')[0].clientWidth

    canvasElement.height = ccw;
    canvasElement.width = ccw;
    let h=video.videoHeight, w=video.videoWidth;
    if(h<w){
      canvas.drawImage(video, Math.floor((w-ccw)/2), 0, ccw, ccw);
    }else{
      canvas.drawImage(video,0,Math.floor((h-ccw)/2),ccw, ccw);
    }
    var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
    var code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: "dontInvert",
    });
    if (code) {
      drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
      drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
      drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
      drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
      console.log(code.data)
      var res = code.data.match(self.reg);
      console.log(res)
      if(res){
        if(res[1]=="place_id"){
          confQR(res[2])
          return
        }else if(res[1]=="card_token") {
          assignTeam(res[2])
          return
        }
      }
    }
    }
    requestAnimationFrame(tick);

  }

  function inputDescriptions(shop){
    const elem = document.getElementsByClassName('shopName')[0];
    var text =`店名:${shop.name}`;
    elem.innerHTML = text;
    document.getElementById('popup').style.display='block';
  }

  const confQR=(placeID) => {
    form.place_id.value=placeID;
    const formData = new FormData(form);
    var jsonObject = {};
    formData.forEach((value, key) => { jsonObject[key] = value; });
    const options = {
      method: 'POST',
      body: formData,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(jsonObject),
    }
    const url = form.getAttribute('action');
    fetch(url, options)
      .then((res)=>{
        if(res.ok) {
          return res.json()
        } else {
          res.json().then(data => {
            if (data.detail) {
              const errorDetail = data.detail;
              console.log('Team Registration Error:', errorDetail);
              // エラーメッセージに基づいて適切な処理を行う
              document.getElementById("popup-body").innerHTML=`<p>${errorDetail}</p>`;
              document.getElementById("popup").style.display='block';
            } else {
              throw new Error('Unknown error occurred');
            }
          })
        }
      })
      .then(data =>{
        document.getElementById("loading").hidden=true;
        if (!data.name){
          tick()
        }else{
          batsudiv.onclick=()=>{
            document.getElementById('popup').style.display='none';
            startScan()
          }
          placename=data.name
          document.getElementsByClassName('placeName')[0].innerText=data.name;
          if("already" in data){
            document.getElementById('stamp_result').innerHTML="<p>2度目です!!</p>";
            document.getElementById("tweet-button").href+=`&&text=${data.name}にいきました%0d`;
          }else if("error" in data){
            document.getElementById('description').innerHTML="<p>開催までお待ちください</p>";
            document.getElementById("tweet-button").style="display: none;"
          }else{
            if(data.end_text) {
              document.getElementById('stamp_result').innerText=data.end_text;
            } else {
              document.getElementById('stamp_num').innerText=data.count;
            }
            document.getElementById("tweet-button").href+=`&&text=${data.name}にいきました%0d`;
          }
          document.getElementById('popup').style.display='block';
        }
      })
      .catch(e=>{
        tick()
      });

  }

  const assignTeam=(cardToken) => {
    form.card_token.value=cardToken;
    const formData = new FormData(form);
    var jsonObject = {};
    formData.forEach((value, key) => { jsonObject[key] = value; });
    const options = {
      method: 'POST',
      body: formData,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(jsonObject),
    }
    const sub_first = (str) => {
      if (str.startsWith("/")) {
          str = str.substring(1);
      }
      return str
    }
    fetch("{{ base_url }}card/", options)
      .then((res)=>{
        if(res.ok) {
          return res.json()
        } else {
          res.json().then(data => {
            if (data.detail) {
              const errorDetail = data.detail;
              console.log('Team Registration Error:', errorDetail);
              // エラーメッセージに基づいて適切な処理を行う
              document.getElementById("popup-body").innerHTML=`<p>${errorDetail}</p>`;
              document.getElementById("popup").style.display='block';
            } else {
              throw new Error('Unknown error occurred');
            }
          })
        }
      })
      .then(data =>{
        document.getElementById("loading").hidden=true;
        if (!data.name){
          tick()
        }else{
          document.getElementById("popup-body").innerHTML=data.html;
          document.getElementById('popup').style.display='block';
        }
      })
      .catch(e=>{
        tick()
      });

  }

  const form = document.forms.stampForm
</script>
